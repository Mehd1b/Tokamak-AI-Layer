<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800" width="1200" height="800">
  <defs>
    <style>
      .title { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 18px; font-weight: 600; fill: #1e3a5f; }
      .label { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 11px; fill: #374151; }
      .label-bold { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 11px; font-weight: 600; fill: #1f2937; }
      .code { font-family: 'Courier New', monospace; font-size: 9px; fill: #4b5563; }
      .code-small { font-family: 'Courier New', monospace; font-size: 8px; fill: #6b7280; }
      .step-num { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 12px; font-weight: 700; fill: #2563eb; }
      .fragment-label { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 9px; font-weight: 600; fill: #6b7280; }
      .annotation { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 8px; fill: #6b7280; }
    </style>
    <marker id="arrowhead" markerWidth="12" markerHeight="8" refX="11" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <polygon points="0 0, 11 4, 0 8" fill="#4b5563"/>
    </marker>
    <marker id="arrowhead-return" markerWidth="12" markerHeight="8" refX="11" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <polygon points="0 0, 11 4, 0 8" fill="#059669"/>
    </marker>
    <marker id="arrowhead-blue" markerWidth="12" markerHeight="8" refX="11" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <polygon points="0 0, 11 4, 0 8" fill="#2563eb"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1200" height="800" fill="#fafafa"/>

  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" class="title">Tokamak AI Layer â€” Agent Registration Flow</text>

  <!-- Participants -->
  <g id="participants">
    <!-- User (Actor) -->
    <g transform="translate(70, 55)">
      <circle cx="20" cy="12" r="10" fill="#2563eb" stroke="#1e3a5f" stroke-width="1.5"/>
      <line x1="20" y1="22" x2="20" y2="42" stroke="#1e3a5f" stroke-width="2"/>
      <line x1="5" y1="30" x2="35" y2="30" stroke="#1e3a5f" stroke-width="2"/>
      <line x1="20" y1="42" x2="8" y2="58" stroke="#1e3a5f" stroke-width="2"/>
      <line x1="20" y1="42" x2="32" y2="58" stroke="#1e3a5f" stroke-width="2"/>
      <text x="20" y="72" text-anchor="middle" class="label-bold">User</text>
    </g>

    <!-- Frontend -->
    <g transform="translate(170, 55)">
      <rect x="0" y="0" width="80" height="36" rx="4" fill="#dbeafe" stroke="#2563eb" stroke-width="1.5"/>
      <text x="40" y="22" text-anchor="middle" class="label-bold">Frontend</text>
      <text x="40" y="50" text-anchor="middle" class="annotation">(Next.js)</text>
    </g>

    <!-- RegistrationBuilder -->
    <g transform="translate(290, 55)">
      <rect x="0" y="0" width="100" height="36" rx="4" fill="#ede9fe" stroke="#7c3aed" stroke-width="1.5"/>
      <text x="50" y="22" text-anchor="middle" class="label-bold">RegistrationBuilder</text>
      <text x="50" y="50" text-anchor="middle" class="annotation">(SDK)</text>
    </g>

    <!-- IPFS -->
    <g transform="translate(430, 55)">
      <rect x="0" y="0" width="70" height="36" rx="4" fill="#f3f4f6" stroke="#9ca3af" stroke-width="1.5" stroke-dasharray="4,2"/>
      <text x="35" y="22" text-anchor="middle" class="label-bold">IPFS</text>
      <text x="35" y="50" text-anchor="middle" class="annotation">(External)</text>
    </g>

    <!-- IdentityClient -->
    <g transform="translate(540, 55)">
      <rect x="0" y="0" width="90" height="36" rx="4" fill="#ede9fe" stroke="#7c3aed" stroke-width="1.5"/>
      <text x="45" y="22" text-anchor="middle" class="label-bold">IdentityClient</text>
      <text x="45" y="50" text-anchor="middle" class="annotation">(SDK)</text>
    </g>

    <!-- TALIdentityRegistry -->
    <g transform="translate(680, 55)">
      <rect x="0" y="0" width="120" height="36" rx="4" fill="#c4b5fd" stroke="#5b21b6" stroke-width="1.5"/>
      <text x="60" y="22" text-anchor="middle" class="label-bold">TALIdentityRegistry</text>
      <text x="60" y="50" text-anchor="middle" class="annotation">(L2 Contract)</text>
    </g>

    <!-- TALStakingBridgeL2 -->
    <g transform="translate(850, 55)">
      <rect x="0" y="0" width="120" height="36" rx="4" fill="#c4b5fd" stroke="#5b21b6" stroke-width="1.5"/>
      <text x="60" y="22" text-anchor="middle" class="label-bold">TALStakingBridgeL2</text>
      <text x="60" y="50" text-anchor="middle" class="annotation">(L2 Contract)</text>
    </g>
  </g>

  <!-- Lifelines -->
  <g id="lifelines">
    <line x1="90" y1="130" x2="90" y2="780" stroke="#2563eb" stroke-width="1" stroke-dasharray="4,3"/>
    <line x1="210" y1="130" x2="210" y2="780" stroke="#2563eb" stroke-width="1" stroke-dasharray="4,3"/>
    <line x1="340" y1="130" x2="340" y2="780" stroke="#7c3aed" stroke-width="1" stroke-dasharray="4,3"/>
    <line x1="465" y1="130" x2="465" y2="780" stroke="#9ca3af" stroke-width="1" stroke-dasharray="4,3"/>
    <line x1="585" y1="130" x2="585" y2="780" stroke="#7c3aed" stroke-width="1" stroke-dasharray="4,3"/>
    <line x1="740" y1="130" x2="740" y2="780" stroke="#5b21b6" stroke-width="1" stroke-dasharray="4,3"/>
    <line x1="910" y1="130" x2="910" y2="780" stroke="#5b21b6" stroke-width="1" stroke-dasharray="4,3"/>
  </g>

  <!-- Step 1: User Input -->
  <g id="step1">
    <text x="25" y="155" class="step-num">1</text>
    <line x1="90" y1="150" x2="200" y2="150" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="145" y="145" text-anchor="middle" class="label">Fill registration form</text>

    <!-- Annotation box -->
    <rect x="100" y="158" width="120" height="38" rx="3" fill="#f9fafb" stroke="#e5e7eb" stroke-width="1"/>
    <text x="108" y="171" class="code-small">name, description,</text>
    <text x="108" y="182" class="code-small">services[], capabilities[]</text>
    <text x="108" y="193" class="code-small">metadataHash</text>
  </g>

  <!-- Step 2: Build Registration File -->
  <g id="step2">
    <text x="25" y="220" class="step-num">2</text>

    <line x1="210" y1="215" x2="330" y2="215" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="270" y="210" text-anchor="middle" class="code">setName(name)</text>

    <line x1="210" y1="232" x2="330" y2="232" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="270" y="227" text-anchor="middle" class="code">.addService({type, endpoint})</text>

    <line x1="210" y1="249" x2="330" y2="249" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="270" y="244" text-anchor="middle" class="code">.addCapability({name, version})</text>

    <line x1="210" y1="266" x2="330" y2="266" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="270" y="261" text-anchor="middle" class="code">.build()</text>

    <!-- Internal validation -->
    <rect x="325" y="272" width="30" height="18" rx="2" fill="#ede9fe" stroke="#7c3aed" stroke-width="1"/>
    <text x="340" y="284" text-anchor="middle" class="code-small">validate</text>

    <!-- Return -->
    <line x1="330" y1="298" x2="220" y2="298" stroke="#059669" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead-return)"/>
    <text x="275" y="293" text-anchor="middle" class="code" fill="#059669">AgentRegistrationFile</text>

    <!-- Annotation box for AgentRegistrationFile -->
    <rect x="355" y="210" width="95" height="55" rx="3" fill="#f9fafb" stroke="#e5e7eb" stroke-width="1"/>
    <text x="363" y="223" class="code-small" font-weight="600">AgentRegistrationFile:</text>
    <text x="363" y="235" class="code-small">{name, description,</text>
    <text x="363" y="247" class="code-small"> version, services[],</text>
    <text x="363" y="259" class="code-small"> capabilities[]}</text>
  </g>

  <!-- Step 3: Upload to IPFS -->
  <g id="step3">
    <text x="25" y="325" class="step-num">3</text>

    <line x1="210" y1="320" x2="330" y2="320" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="270" y="315" text-anchor="middle" class="code">uploadToIPFS(pinataConfig)</text>

    <line x1="340" y1="337" x2="455" y2="337" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="397" y="332" text-anchor="middle" class="code">POST JSON</text>

    <line x1="455" y1="354" x2="350" y2="354" stroke="#059669" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead-return)"/>
    <text x="402" y="349" text-anchor="middle" class="code" fill="#059669">ipfs://QmHash</text>

    <line x1="330" y1="371" x2="220" y2="371" stroke="#059669" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead-return)"/>
    <text x="275" y="366" text-anchor="middle" class="code" fill="#059669">URI string</text>
  </g>

  <!-- Step 4: On-Chain Registration (with ALT fragment) -->
  <g id="step4">
    <text x="25" y="405" class="step-num">4</text>

    <!-- ALT fragment box -->
    <rect x="195" y="390" width="570" height="185" rx="3" fill="none" stroke="#9ca3af" stroke-width="1.5"/>
    <rect x="195" y="390" width="35" height="16" fill="#e5e7eb" stroke="#9ca3af" stroke-width="1"/>
    <text x="212" y="401" class="fragment-label">alt</text>

    <!-- Path A label -->
    <text x="205" y="418" class="annotation" font-weight="600">[Standard Registration]</text>

    <!-- Path A: Standard Registration -->
    <line x1="210" y1="428" x2="575" y2="428" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="392" y="423" text-anchor="middle" class="code">TALClient.registerAgent({agentURI})</text>

    <line x1="585" y1="445" x2="730" y2="445" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="657" y="440" text-anchor="middle" class="code">register(agentURI)</text>

    <!-- Internal action box -->
    <rect x="725" y="452" width="30" height="28" rx="2" fill="#c4b5fd" stroke="#5b21b6" stroke-width="1"/>
    <text x="740" y="462" text-anchor="middle" class="code-small">Mint</text>
    <text x="740" y="473" text-anchor="middle" class="code-small">NFT</text>

    <!-- Annotation for internal -->
    <rect x="760" y="448" width="85" height="35" rx="3" fill="#f9fafb" stroke="#e5e7eb" stroke-width="1"/>
    <text x="768" y="461" class="code-small">agentId = ++count</text>
    <text x="768" y="473" class="code-small">emit Registered(</text>
    <text x="768" y="483" class="code-small">  agentId, owner)</text>

    <!-- Returns for Path A -->
    <line x1="730" y1="492" x2="595" y2="492" stroke="#059669" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead-return)"/>
    <text x="662" y="487" text-anchor="middle" class="code" fill="#059669">agentId</text>

    <line x1="575" y1="506" x2="220" y2="506" stroke="#059669" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead-return)"/>
    <text x="397" y="501" text-anchor="middle" class="code" fill="#059669">agentId</text>

    <!-- Divider line -->
    <line x1="195" y1="522" x2="765" y2="522" stroke="#9ca3af" stroke-width="1" stroke-dasharray="3,3"/>

    <!-- Path B label -->
    <text x="205" y="537" class="annotation" font-weight="600">[ZK Identity Registration]</text>

    <!-- Path B: ZK Registration -->
    <line x1="210" y1="547" x2="575" y2="547" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="392" y="542" text-anchor="middle" class="code">registerWithZKIdentity(agentURI, zkCommitment)</text>

    <line x1="585" y1="562" x2="730" y2="562" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="657" y="557" text-anchor="middle" class="code">registerWithZKIdentity(...)</text>
  </g>

  <!-- Step 5: Optional Operator Setup -->
  <g id="step5">
    <text x="25" y="605" class="step-num">5</text>

    <!-- OPT fragment box -->
    <rect x="195" y="590" width="735" height="115" rx="3" fill="none" stroke="#9ca3af" stroke-width="1.5" stroke-dasharray="6,3"/>
    <rect x="195" y="590" width="30" height="16" fill="#f3f4f6" stroke="#9ca3af" stroke-width="1"/>
    <text x="210" y="601" class="fragment-label">opt</text>
    <text x="232" y="601" class="annotation">[Operator Setup]</text>

    <line x1="210" y1="618" x2="575" y2="618" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="392" y="613" text-anchor="middle" class="code">setOperator(agentId, operatorAddress)</text>

    <line x1="585" y1="635" x2="730" y2="635" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="657" y="630" text-anchor="middle" class="code">setOperator(agentId, operator)</text>

    <line x1="585" y1="652" x2="730" y2="652" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="657" y="647" text-anchor="middle" class="code">refreshOperatorStatus(agentId)</text>

    <line x1="740" y1="669" x2="900" y2="669" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="820" y="664" text-anchor="middle" class="code">isVerifiedOperator(operator)</text>

    <line x1="900" y1="686" x2="750" y2="686" stroke="#059669" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead-return)"/>
    <text x="825" y="681" text-anchor="middle" class="code" fill="#059669">bool (verified?)</text>

    <!-- Internal action -->
    <rect x="725" y="692" width="30" height="14" rx="2" fill="#c4b5fd" stroke="#5b21b6" stroke-width="1"/>
    <text x="740" y="702" text-anchor="middle" class="code-small">Update</text>
  </g>

  <!-- Step 6: Completion -->
  <g id="step6">
    <text x="25" y="730" class="step-num">6</text>

    <line x1="210" y1="725" x2="100" y2="725" stroke="#059669" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead-return)"/>
    <text x="155" y="720" text-anchor="middle" class="code" fill="#059669">Redirect to /agents/[agentId]</text>

    <!-- Success indicator -->
    <circle cx="90" cy="750" r="12" fill="#d1fae5" stroke="#059669" stroke-width="2"/>
    <path d="M84 750 L88 754 L96 746" stroke="#059669" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    <text x="115" y="754" class="label" fill="#059669" font-weight="600">Success</text>
  </g>

  <!-- Legend -->
  <g id="legend" transform="translate(980, 130)">
    <rect x="0" y="0" width="190" height="95" rx="4" fill="#f9fafb" stroke="#e5e7eb" stroke-width="1"/>
    <text x="95" y="18" text-anchor="middle" class="label-bold">Legend</text>

    <line x1="15" y1="35" x2="55" y2="35" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="65" y="39" class="annotation">Synchronous call</text>

    <line x1="15" y1="52" x2="55" y2="52" stroke="#059669" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowhead-return)"/>
    <text x="65" y="56" class="annotation">Return</text>

    <rect x="15" y="65" width="40" height="12" rx="2" fill="none" stroke="#9ca3af" stroke-width="1"/>
    <text x="65" y="75" class="annotation">alt = alternatives</text>

    <rect x="15" y="82" width="40" height="12" rx="2" fill="none" stroke="#9ca3af" stroke-width="1" stroke-dasharray="4,2"/>
    <text x="65" y="92" class="annotation">opt = optional</text>
  </g>

  <!-- Color legend for participants -->
  <g id="color-legend" transform="translate(980, 240)">
    <rect x="0" y="0" width="190" height="75" rx="4" fill="#f9fafb" stroke="#e5e7eb" stroke-width="1"/>
    <text x="95" y="18" text-anchor="middle" class="label-bold">Participant Colors</text>

    <rect x="15" y="28" width="12" height="12" rx="2" fill="#dbeafe" stroke="#2563eb" stroke-width="1"/>
    <text x="35" y="38" class="annotation">Frontend (Next.js)</text>

    <rect x="15" y="45" width="12" height="12" rx="2" fill="#ede9fe" stroke="#7c3aed" stroke-width="1"/>
    <text x="35" y="55" class="annotation">SDK Components</text>

    <rect x="15" y="62" width="12" height="12" rx="2" fill="#c4b5fd" stroke="#5b21b6" stroke-width="1"/>
    <text x="35" y="72" class="annotation">L2 Contracts</text>
  </g>

</svg>